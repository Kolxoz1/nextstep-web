<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NextStep</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #F8FAFC; overflow-x: hidden; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 999; }
        .modal-content { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 24px 24px 0 0; z-index: 1000; max-height: 85vh; overflow-y: auto; padding: 24px; }
        .task-card:active { transform: scale(0.98); transition: 0.2s; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        const t = {
            ru: {
                inbox: 'Inbox', today: '–°–µ–≥–æ–¥–Ω—è', focus: '–§–æ–∫—É—Å', review: '–ì–æ—Ç–æ–≤–æ',
                habits: '–ü—Ä–∏–≤—ã—á–∫–∏', stats: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', subscription: '–ü–æ–¥–ø–∏—Å–∫–∞',
                support: '–ü–æ–º–æ—â—å', settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', admin: '–ê–¥–º–∏–Ω',
                tasks: '–∑–∞–¥–∞—á', noTasks: '–ó–∞–¥–∞—á –Ω–µ—Ç', addTask: '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É',
                newTask: '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞', priority: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç',
                high: '–í—ã—Å–æ–∫–∏–π', medium: '–°—Ä–µ–¥–Ω–∏–π', low: '–ù–∏–∑–∫–∏–π', cancel: '–û—Ç–º–µ–Ω–∞',
                total: '–í—Å–µ–≥–æ', completed: '–ì–æ—Ç–æ–≤–æ', language: '–Ø–∑—ã–∫',
                russian: '–†—É—Å—Å–∫–∏–π', english: 'English', helpTitle: '–ü–æ–º–æ—â—å',
                helpText: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏ –∏ –ø—Ä–∏–≤—ã—á–∫–∞–º–∏',
                writeSupport: '–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É', free: 'FREE', premium: 'PREMIUM', pro: 'PRO',
                features: '–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏', current: '–¢–µ–∫—É—â–∏–π', subscribe: '–û—Ñ–æ—Ä–º–∏—Ç—å',
                securePayment: '–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Telegram'
            },
            en: {
                inbox: 'Inbox', today: 'Today', focus: 'Focus', review: 'Done',
                habits: 'Habits', stats: 'Stats', subscription: 'Premium',
                support: 'Help', settings: 'Settings', admin: 'Admin',
                tasks: 'tasks', noTasks: 'No tasks', addTask: 'Add task',
                newTask: 'New task', priority: 'Priority',
                high: 'High', medium: 'Medium', low: 'Low', cancel: 'Cancel',
                total: 'Total', completed: 'Done', language: 'Language',
                russian: '–†—É—Å—Å–∫–∏–π', english: 'English', helpTitle: 'Help',
                helpText: 'Use app to manage tasks and habits',
                writeSupport: 'Contact support', free: 'FREE', premium: 'PREMIUM', pro: 'PRO',
                features: 'Features', current: 'Current', subscribe: 'Subscribe',
                securePayment: 'Secure payment via Telegram'
            }
        };

        class App {
            constructor() {
                this.view = 'inbox';
                this.tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                this.habits = JSON.parse(localStorage.getItem('habits') || '[]');
                this.lang = localStorage.getItem('lang') || 'ru';
                this.isAdmin = tg.initDataUnsafe?.user?.id === 6245543040;
                this.init();
            }

            tr(key) { return t[this.lang][key] || key; }

            init() {
                tg.MainButton.setText(`‚ûï ${this.tr('addTask')}`);
                tg.MainButton.onClick(() => this.showAddModal());
                tg.MainButton.show();
                tg.BackButton.onClick(() => this.setView('inbox'));
                this.render();
            }

            setView(v) {
                this.view = v;
                v === 'inbox' ? tg.BackButton.hide() : tg.BackButton.show();
                this.render();
            }

            addTask(text, priority = 'medium') {
                if (!text) return;
                this.tasks.unshift({
                    id: Date.now(), text, priority, status: this.view,
                    completed: false, date: new Date().toISOString().split('T')[0]
                });
                localStorage.setItem('tasks', JSON.stringify(this.tasks));
                tg.sendData(JSON.stringify({ action: 'add_task', title: text, priority }));
                this.render();
            }

            toggleTask(id) {
                const task = this.tasks.find(t => t.id === id);
                if (task) {
                    task.completed = !task.completed;
                    localStorage.setItem('tasks', JSON.stringify(this.tasks));
                    this.render();
                }
            }

            deleteTask(id) {
                this.tasks = this.tasks.filter(t => t.id !== id);
                localStorage.setItem('tasks', JSON.stringify(this.tasks));
                this.render();
            }

            moveTask(id, status) {
                const task = this.tasks.find(t => t.id === id);
                if (task) {
                    task.status = status;
                    localStorage.setItem('tasks', JSON.stringify(this.tasks));
                    this.render();
                }
            }

            changeLang(lang) {
                this.lang = lang;
                localStorage.setItem('lang', lang);
                this.init();
            }

            showAddModal() {
                const modal = document.createElement('div');
                modal.innerHTML = `
                    <div class="modal-backdrop" onclick="app.closeModal()"></div>
                    <div class="modal-content">
                        <h3 class="text-2xl font-bold mb-4 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">‚ú® ${this.tr('newTask')}</h3>
                        <input type="text" id="taskInput" placeholder="${this.tr('newTask')}..." 
                            class="w-full p-4 border-2 rounded-2xl mb-4 text-lg focus:border-purple-500 focus:outline-none">
                        <p class="text-sm font-semibold mb-3 text-gray-700">${this.tr('priority')}:</p>
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <button onclick="app.addFromModal('high')" class="py-4 bg-gradient-to-br from-red-400 to-red-600 text-white rounded-2xl font-bold shadow-lg active:shadow-md">
                                üî¥ ${this.tr('high')}
                            </button>
                            <button onclick="app.addFromModal('medium')" class="py-4 bg-gradient-to-br from-yellow-400 to-orange-500 text-white rounded-2xl font-bold shadow-lg active:shadow-md">
                                üü° ${this.tr('medium')}
                            </button>
                            <button onclick="app.addFromModal('low')" class="py-4 bg-gradient-to-br from-green-400 to-green-600 text-white rounded-2xl font-bold shadow-lg active:shadow-md">
                                üü¢ ${this.tr('low')}
                            </button>
                        </div>
                        <button onclick="app.closeModal()" class="w-full py-4 bg-gray-100 text-gray-700 rounded-2xl font-semibold active:bg-gray-200">
                            ${this.tr('cancel')}
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => document.getElementById('taskInput')?.focus(), 100);
            }

            addFromModal(priority) {
                const input = document.getElementById('taskInput');
                if (input?.value.trim()) {
                    this.addTask(input.value, priority);
                    this.closeModal();
                }
            }

            closeModal() {
                document.querySelectorAll('.modal-backdrop').forEach(m => m.parentElement?.remove());
            }

            getFiltered() {
                return this.tasks.filter(t => {
                    if (this.view === 'inbox') return t.status === 'inbox' && !t.completed;
                    if (this.view === 'today') return t.status === 'today' && !t.completed;
                    if (this.view === 'focus') return t.status === 'focus' && !t.completed;
                    if (this.view === 'review') return t.completed;
                    return true;
                });
            }

            render() {
                const tasks = this.getFiltered();
                const completed = this.tasks.filter(t => t.completed).length;
                
                document.getElementById('root').innerHTML = `
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4 sticky top-0 z-50 shadow-lg">
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <h1 class="text-2xl font-bold">NextStep</h1>
                                <p class="text-sm opacity-90">${new Date().toLocaleDateString(this.lang === 'ru' ? 'ru-RU' : 'en-US', {weekday: 'long', day: 'numeric', month: 'long'})}</p>
                            </div>
                            <div class="bg-white/20 backdrop-blur px-4 py-2 rounded-full">
                                <span class="font-bold text-sm">${tasks.length} ${this.tr('tasks')}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 overflow-x-auto scrollbar-hide pb-2 -mx-4 px-4">
                            ${['inbox', 'today', 'focus', 'review', 'habits', 'stats', 'subscription', 'support', 'settings', ...(this.isAdmin ? ['admin'] : [])].map(v => `
                                <button onclick="app.setView('${v}')" class="px-4 py-2.5 rounded-full whitespace-nowrap transition-all ${this.view === v ? 'bg-white text-purple-600 shadow-lg scale-105' : 'bg-white/20 hover:bg-white/30'} font-semibold text-sm">
                                    ${this.tr(v)}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="p-4 pb-24">
                        ${this.view === 'stats' ? this.renderStats(completed) : 
                          this.view === 'settings' ? this.renderSettings() :
                          this.view === 'subscription' ? this.renderSubscription() :
                          this.view === 'support' ? this.renderSupport() :
                          this.view === 'admin' && this.isAdmin ? this.renderAdmin() :
                          this.renderTasks(tasks)}
                    </div>
                `;
            }

            renderTasks(tasks) {
                if (!tasks.length) {
                    return `
                        <div class="text-center py-20">
                            <div class="w-28 h-28 bg-gradient-to-br from-purple-100 to-pink-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <span class="text-6xl">‚ú®</span>
                            </div>
                            <p class="text-xl font-semibold text-gray-600 mb-2">${this.tr('noTasks')}</p>
                            <p class="text-gray-400 text-sm">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å</p>
                        </div>
                    `;
                }

                return tasks.map(t => `
                    <div class="task-card bg-white rounded-2xl p-5 mb-3 shadow-md border border-purple-50">
                        <div class="flex gap-4">
                            <button onclick="app.toggleTask(${t.id})" class="w-8 h-8 rounded-full border-2 flex items-center justify-center flex-shrink-0 transition-all ${t.completed ? 'bg-gradient-to-br from-green-400 to-green-600 border-green-600' : 'border-gray-300 hover:border-purple-500'}">
                                ${t.completed ? '<span class="text-white text-lg font-bold">‚úì</span>' : ''}
                            </button>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-base ${t.completed ? 'line-through text-gray-400' : 'text-gray-800'}">${t.text}</p>
                                <div class="flex gap-2 mt-3 flex-wrap items-center">
                                    <span class="text-xs px-3 py-1.5 rounded-full font-semibold shadow-sm ${
                                        t.priority === 'high' ? 'bg-gradient-to-r from-red-400 to-red-500 text-white' : 
                                        t.priority === 'medium' ? 'bg-gradient-to-r from-yellow-400 to-orange-400 text-white' : 
                                        'bg-gradient-to-r from-green-400 to-green-500 text-white'
                                    }">
                                        ${t.priority === 'high' ? 'üî¥' : t.priority === 'medium' ? 'üü°' : 'üü¢'} ${this.tr(t.priority)}
                                    </span>
                                    ${!t.completed ? `
                                        <select onchange="app.moveTask(${t.id}, this.value)" class="text-xs px-3 py-1.5 rounded-full bg-purple-50 text-purple-700 border-none font-medium">
                                            <option value="inbox" ${t.status === 'inbox' ? 'selected' : ''}>üì• Inbox</option>
                                            <option value="today" ${t.status === 'today' ? 'selected' : ''}>üìÖ Today</option>
                                            <option value="focus" ${t.status === 'focus' ? 'selected' : ''}>üéØ Focus</option>
                                        </select>
                                    ` : ''}
                                </div>
                            </div>
                            <button onclick="app.deleteTask(${t.id})" class="text-red-400 hover:text-red-600 text-2xl font-bold">√ó</button>
                        </div>
                    </div>
                `).join('');
            }

            renderStats(completed) {
                return `
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        ${[
                            { icon: 'üìã', label: this.tr('total'), value: this.tasks.length, color: 'from-blue-400 to-blue-600' },
                            { icon: '‚úÖ', label: this.tr('completed'), value: completed, color: 'from-green-400 to-green-600' },
                            { icon: '‚ú®', label: this.tr('habits'), value: this.habits.length, color: 'from-purple-400 to-purple-600' },
                            { icon: 'üî•', label: 'Streak', value: 0, color: 'from-orange-400 to-red-600' }
                        ].map(s => `
                            <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
                                <div class="w-14 h-14 bg-gradient-to-br ${s.color} rounded-2xl flex items-center justify-center mb-3 text-2xl">
                                    ${s.icon}
                                </div>
                                <p class="text-sm text-gray-600 font-medium mb-1">${s.label}</p>
                                <p class="text-4xl font-bold bg-gradient-to-r ${s.color} bg-clip-text text-transparent">${s.value}</p>
                            </div>
                        `).join('')}
                    </div>
                    <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
                        <h3 class="font-bold text-lg mb-4 text-gray-800">üìà ${this.tr('stats')}</h3>
                        ${['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].map(day => {
                            const percent = Math.random() * 100;
                            return `
                                <div class="flex items-center gap-3 mb-3">
                                    <span class="text-sm font-medium text-gray-600 w-10">${day}</span>
                                    <div class="flex-1 bg-gray-200 rounded-full h-3 overflow-hidden">
                                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all" style="width: ${percent}%"></div>
                                    </div>
                                    <span class="text-sm font-bold text-gray-700 w-12 text-right">${Math.floor(percent)}%</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            renderSettings() {
                return `
                    <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
                        <h3 class="font-bold text-xl mb-6 text-gray-800">‚öôÔ∏è ${this.tr('settings')}</h3>
                        <div class="mb-6">
                            <p class="font-semibold mb-3 text-gray-700">${this.tr('language')}</p>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="app.changeLang('ru')" class="py-4 rounded-2xl font-bold transition-all ${this.lang === 'ru' ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    ${this.tr('russian')}
                                </button>
                                <button onclick="app.changeLang('en')" class="py-4 rounded-2xl font-bold transition-all ${this.lang === 'en' ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    ${this.tr('english')}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderSubscription() {
                const plans = [
                    { name: this.tr('free'), icon: 'üÜì', price: 0, features: ['–î–æ 50 –∑–∞–¥–∞—á', '–ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏', '–¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫'], color: 'from-gray-400 to-gray-600', current: true },
                    { name: this.tr('premium'), icon: '‚≠ê', price: '149‚ÇΩ/–º–µ—Å', features: ['–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏', '–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', '–¢–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è', '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞'], color: 'from-purple-500 to-pink-500' },
                    { name: this.tr('pro'), icon: 'üèÜ', price: '219‚ÇΩ/–º–µ—Å', features: ['–í—Å—ë –∏–∑ Premium', 'AI-–ø–æ–º–æ—â–Ω–∏–∫', '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏', 'API –¥–æ—Å—Ç—É–ø'], color: 'from-orange-500 to-red-600' }
                ];
                
                return plans.map(p => `
                    <div class="bg-white rounded-2xl p-6 shadow-lg border ${p.current ? 'border-purple-500 border-2' : 'border-gray-100'} mb-4">
                        ${p.current ? '<div class="inline-block bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full mb-3">'+this.tr('current')+'</div>' : ''}
                        <div class="flex items-center gap-3 mb-4">
                            <span class="text-4xl">${p.icon}</span>
                            <div>
                                <h3 class="text-2xl font-bold bg-gradient-to-r ${p.color} bg-clip-text text-transparent">${p.name}</h3>
                                <p class="text-gray-600 font-semibold">${p.price || '–ù–∞–≤—Å–µ–≥–¥–∞'}</p>
                            </div>
                        </div>
                        <div class="space-y-2 mb-4">
                            ${p.features.map(f => `<div class="flex items-center gap-2 text-gray-700"><span class="text-green-500">‚úì</span><span class="text-sm">${f}</span></div>`).join('')}
                        </div>
                        ${!p.current && p.price ? `<button class="w-full py-4 bg-gradient-to-r ${p.color} text-white rounded-2xl font-bold shadow-lg">${this.tr('subscribe')}</button>` : ''}
                    </div>
                `).join('') + `<p class="text-xs text-gray-500 text-center mt-4">${this.tr('securePayment')}</p>`;
            }

            renderSupport() {
                return `
                    <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
                        <div class="text-center mb-6">
                            <div class="w-24 h-24 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-5xl">üí¨</span>
                            </div>
                            <h2 class="text-3xl font-bold mb-2 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">${this.tr('helpTitle')}</h2>
                            <p class="text-gray-600">${this.tr('helpText')}</p>
                        </div>
                        <a href="https://t.me/NextStepSupport" class="block">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-2xl p-6 shadow-lg active:scale-98 transition-all">
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur">
                                        <span class="text-3xl">üí¨</span>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-bold text-lg">${this.tr('writeSupport')}</h4>
                                        <p class="text-sm opacity-90">@NextStepSupport</p>
                                    </div>
                                    <span class="text-2xl opacity-70">‚Üí</span>
                                </div>
                            </div>
                        </a>
                    </div>
                `;
            }

            renderAdmin() {
                return `
                    <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
                        <h3 class="font-bold text-xl mb-4 text-gray-800">üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
                        <div class="space-y-3">
                            <div class="p-5 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl border border-purple-100">
                                <p class="text-sm text-gray-600 mb-1">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                                <p class="text-3xl font-bold text-purple-600">1</p>
                            </div>
                            <button onclick="tg.close()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl font-bold shadow-lg">
                                üîê –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                            </button>
                            <p class="text-xs text-gray-500 text-center">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /admin –≤ –±–æ—Ç–µ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
                        </div>
                    </div>
                `;
            }
        }

        const app = new App();
        window.app = app;
    </script>
</body>
</html>