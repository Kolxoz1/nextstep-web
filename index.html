<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NextStep</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
:root {
  --bg: #F9FAFB;
  --card: #FFFFFF;
  --border: #E5E7EB;
  --text: #111827;
  --muted: #6B7280;
  --accent: #6C63FF;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}


.text-muted {
  color: var(--muted);
}

/* –∫–Ω–æ–ø–∫–∞ + */
.floating-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 52px;
  height: 52px;
  border-radius: 16px;
  background: #6C63FF;
  color: white;
  font-size: 26px;
  box-shadow: 0 10px 25px rgba(108,99,255,.35);
}

/* –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.25);
}

.modal-content {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  border-radius: 16px 16px 0 0;
  padding: 20px;
}
/* –∫–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–¥–∞—á–∏ ‚Äî –∂–∏–≤–∞—è, –Ω–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–∞—è */
.card {
  background: #ffffff;
  border-radius: 14px;
  margin: 8px 12px;
  padding: 12px;
  box-shadow:
    0 1px 2px rgba(0,0,0,0.04),
    0 6px 16px rgba(0,0,0,0.06);
  transition: box-shadow 0.15s ease, transform 0.15s ease;
}

/* –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ‚Äî –æ—â—É—â–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ */
.card:active {
  transform: scale(0.985);
  box-shadow:
    0 1px 2px rgba(0,0,0,0.04),
    0 3px 8px rgba(0,0,0,0.08);
}
.fab {
  position: fixed;
  right: 20px;
  bottom: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  box-shadow: 0 12px 30px rgba(108, 99, 255, 0.45);
  cursor: pointer;
}

.fab:active {
  transform: scale(0.96);
}
/* —Ñ–∏–∫—Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è + –Ω–∞ –ü–ö */
.fab {
  line-height: 0;
}

.fab svg {
  display: block;
  transform: translateY(0.5px);
}
/* hover —Ç–æ–ª—å–∫–æ –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å –º—ã—à—å—é */
@media (hover: hover) {
  .card:hover {
    box-shadow:
      0 2px 6px rgba(0,0,0,0.06),
      0 10px 24px rgba(0,0,0,0.10);
    transform: translateY(-1px);
  }
}
/* hover —Ç–æ–ª—å–∫–æ –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å –º—ã—à—å—é */
@media (hover: hover) {
  .fab:hover {
    transform: scale(1.06);
    box-shadow: 0 18px 40px rgba(108, 99, 255, 0.6);
  }
}
.habits-wrap {
  margin: 16px;
  padding: 8px 0;
  background: #F5F6FA;
  border-radius: 18px;
}
.stats-wrap {
  margin: 16px;
  padding: 8px 0;
  background: #F5F6FA;
  border-radius: 18px;
}
.support-wrap {
  margin: 16px;
  padding: 8px 0;
  background: #F5F6FA;
  border-radius: 18px;
}
/* =========================
   HEADER ‚Äî –Ø–ö–û–†–¨
   ========================= */

.header {
  position: sticky;
  top: 0;
  z-index: 50;
  background: #fff;

  border-bottom: 1px solid rgba(0, 0, 0, 0.06);
}

/* card –≤–Ω—É—Ç—Ä–∏ header ‚Äî –ù–ï –∫–∞—Ä—Ç–æ—á–∫–∞ */
.header.card {
  box-shadow: none;
  border-radius: 0;
  margin: 0;
}
@media (hover: hover) {
  .tabs button:hover {
    background: rgba(0, 0, 0, 0.04);
  }
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const tgUser = tg.initDataUnsafe?.user;

        const params = new URLSearchParams(window.location.search);
        const planFromUrl = params.get('plan') || 'free';
        const userIdFromUrl = params.get('user_id') || '';

        const t = {
            ru: {
                inbox: '–í—Ö–æ–¥—è—â–∏–µ', today: '–°–µ–≥–æ–¥–Ω—è', focus: '–§–æ–∫—É—Å', review: '–ì–æ—Ç–æ–≤–æ',
                habits: '–ü—Ä–∏–≤—ã—á–∫–∏', stats: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', subscription: '–ü–æ–¥–ø–∏—Å–∫–∞',
                support: '–ü–æ–º–æ—â—å', settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', shopping: '–ü–æ–∫—É–ø–∫–∏',
                tasks: '–∑–∞–¥–∞—á', noTasks: '–ù–µ—Ç –∑–∞–¥–∞—á', addTask: '–î–æ–±–∞–≤–∏—Ç—å',
                newTask: '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞', priority: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç',
                high: '–í—ã—Å–æ–∫–∏–π', medium: '–°—Ä–µ–¥–Ω–∏–π', low: '–ù–∏–∑–∫–∏–π', cancel: '–û—Ç–º–µ–Ω–∞',
                save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', total: '–í—Å–µ–≥–æ', completed: '–ì–æ—Ç–æ–≤–æ', 
                language: '–Ø–∑—ã–∫', theme: '–¢–µ–º–∞', light: '–°–≤–µ—Ç–ª–∞—è', dark: '–¢–µ–º–Ω–∞—è',
                russian: '–†—É—Å—Å–∫–∏–π', english: 'English', helpTitle: '–ü–æ–º–æ—â—å',
                helpText: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏',
                writeSupport: '–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É', free: 'FREE', premium: 'PREMIUM', pro: 'PRO',
                current: '–¢–µ–∫—É—â–∏–π', subscribe: '–û—Ñ–æ—Ä–º–∏—Ç—å',
                shoppingList: '–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫', addItem: '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä—ã',
                estimate: '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å', enterItems: '–í–≤–µ–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫',
                noHabits: '–ù–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫', addHabit: '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É',
                streak: '–°–µ—Ä–∏—è', days: '–¥–Ω–µ–π', checkIn: '–û—Ç–º–µ—Ç–∏—Ç—å',
                newHabit: '–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞', habitName: '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏',
                chooseIcon: '–í—ã–±–µ—Ä–∏—Ç–µ –∏–∫–æ–Ω–∫—É'
            }
        };

// =========================
// –ü—Ä–æ—Å—Ç–µ–π—à–∏–π —Å–ª–æ–≤–∞—Ä—å —Ü–µ–Ω
// =========================

const PRICE_MAP = {
  // –º–æ–ª–æ—á–∫–∞
  –º–æ–ª–æ–∫–æ: 80,
  —Å—ã—Ä: 250,
  –º–∞—Å–ª–æ: 180,
  –π–æ–≥—É—Ä—Ç: 70,
  —Å–º–µ—Ç–∞–Ω–∞: 90,
  —Ç–≤–æ—Ä–æ–≥: 120,

  // —Ö–ª–µ–± –∏ –±–∞–∫–∞–ª–µ—è
  —Ö–ª–µ–±: 50,
  –±–∞—Ç–æ–Ω: 45,
  —Ä–∏—Å: 90,
  –≥—Ä–µ—á–∫–∞: 110,
  –º–∞–∫–∞—Ä–æ–Ω—ã: 70,
  –º—É–∫–∞: 60,
  —Å–∞—Ö–∞—Ä: 75,
  —Å–æ–ª—å: 20,

  // –æ–≤–æ—â–∏
  –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å: 40,
  –∫–∞—Ä—Ç–æ—à–∫–∞: 40,
  –ø–æ–º–∏–¥–æ—Ä—ã: 150,
  –æ–≥—É—Ä—Ü—ã: 130,
  –ª—É–∫: 35,
  –º–æ—Ä–∫–æ–≤—å: 45,
  –∫–∞–ø—É—Å—Ç–∞: 50,

  // —Ñ—Ä—É–∫—Ç—ã
  —è–±–ª–æ–∫–∏: 120,
  –±–∞–Ω–∞–Ω—ã: 110,
  –∞–ø–µ–ª—å—Å–∏–Ω—ã: 140,
  –≥—Ä—É—à–∏: 160,

  // –º—è—Å–æ –∏ —Ä—ã–±–∞
  –∫—É—Ä–∏—Ü–∞: 320,
  –≥–æ–≤—è–¥–∏–Ω–∞: 650,
  —Å–≤–∏–Ω–∏–Ω–∞: 480,
  —Ñ–∞—Ä—à: 420,
  —Ä—ã–±–∞: 500,

  // –Ω–∞–ø–∏—Ç–∫–∏
  –≤–æ–¥–∞: 40,
  —Å–æ–∫: 120,
  —á–∞–π: 180,
  –∫–æ—Ñ–µ: 350,

  // –ø—Ä–æ—á–µ–µ
  —è–π—Ü–∞: 120,
  –∫–æ–ª–±–∞—Å–∞: 300,
  —Å–æ—Å–∏—Å–∫–∏: 260,
  –ø–µ–ª—å–º–µ–Ω–∏: 400
};
// =========================
// –°–ª–æ–≤–∞—Ä—å –∫–∞—Ç–µ–≥–æ—Ä–∏–π
// =========================

const CATEGORY_MAP = {
  products: [
    '–º–æ–ª–æ–∫–æ','—Å—ã—Ä','—Ö–ª–µ–±','—è–±–ª–æ–∫–∏','–±–∞–Ω–∞–Ω—ã','–∫—É—Ä–∏—Ü–∞','—Ä—ã–±–∞',
    '—è–π—Ü–∞','–æ–≤–æ—â–∏','—Ñ—Ä—É–∫—Ç—ã','–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å','—Ä–∏—Å','–º–∞–∫–∞—Ä–æ–Ω—ã',
    '–ø–æ–º–∏–¥–æ—Ä—ã','–æ–≥—É—Ä—Ü—ã','–ª—É–∫','–º–æ—Ä–∫–æ–≤—å','–∫–∞–ø—É—Å—Ç–∞',
    '–∫–æ—Ñ–µ','—á–∞–π','—Å–∞—Ö–∞—Ä','—Å–æ–ª—å'
  ],
  household: [
    '—Ç—É–∞–ª–µ—Ç–Ω–∞—è','–±—É–º–∞–≥–∞','–ø–æ—Ä–æ—à–æ–∫','—à–∞–º–ø—É–Ω—å','–º—ã–ª–æ',
    '–≥—É–±–∫–∞','—Å–∞–ª—Ñ–µ—Ç–∫–∏','–º–æ—é—â–µ–µ','—á–∏—Å—Ç—è—â–µ–µ'
  ]
};
function detectCategory(name) {
  if (!name) return 'products';

  const text = name.toLowerCase();

  for (const category in CATEGORY_MAP) {
    if (CATEGORY_MAP[category].some(word => text.includes(word))) {
      return category;
    }
  }

  return 'products';
}
function estimatePrice(name) {
  if (!name) return 0;

  const text = name.toLowerCase();

  for (const key in PRICE_MAP) {
    if (text.includes(key)) {
      return PRICE_MAP[key];
    }
  }

  return 0;
}
        class App {
            constructor() {
this.user = tgUser || {
  first_name: 'User'
};
                this.view = 'today';
                this.plan = planFromUrl;
                this.userId = userIdFromUrl;
                this.tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                this.habits = JSON.parse(localStorage.getItem('habits') || '[]');
                this.shopping = JSON.parse(localStorage.getItem('shopping') || '[]');
                this.lang = localStorage.getItem('lang') || 'ru';
                this.theme = localStorage.getItem('theme') || 'light';
                this.init();
                this.plan = localStorage.getItem('plan') || 'FREE';

            }

            tr(key) { return t[this.lang]?.[key] || key; }

            init() {
                if (this.theme === 'dark') document.body.classList.add('dark-theme');
                this.render();
            }

            setView(v) {
                this.view = v;
                this.render();
            }

            addTask(text, priority = 'medium') {
                if (!text.trim()) return;
                this.tasks.unshift({
                    id: Date.now(), 
                    text: text.trim(), 
                    priority, 
                    status: 'today',
                    completed: false, 
                    date: new Date().toISOString().split('T')[0]
                });
                localStorage.setItem('tasks', JSON.stringify(this.tasks));
                this.render();
            }

            toggleTask(id) {
                const task = this.tasks.find(t => t.id === id);
                if (task) {
                    task.completed = !task.completed;
                    localStorage.setItem('tasks', JSON.stringify(this.tasks));
                    this.render();
                }
            }

            deleteTask(id) {
                this.tasks = this.tasks.filter(t => t.id !== id);
                localStorage.setItem('tasks', JSON.stringify(this.tasks));
                this.render();
            }

            moveTask(id, status) {
                const task = this.tasks.find(t => t.id === id);
                if (task) {
                    task.status = status;
                    localStorage.setItem('tasks', JSON.stringify(this.tasks));
                    this.render();
                }
            }

            addHabit(text, icon = '‚úÖ') {
                if (!text.trim()) return;
                this.habits.push({
                    id: Date.now(),
                    text: text.trim(),
                    icon,
                    streak: 0,
                    lastDone: null
                });
                localStorage.setItem('habits', JSON.stringify(this.habits));
                this.render();
            }

            checkHabit(id) {
                const habit = this.habits.find(h => h.id === id);
                if (habit) {
                    const today = new Date().toISOString().split('T')[0];
                    if (habit.lastDone === today) return;
                    
                    const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                    if (habit.lastDone === yesterday) {
                        habit.streak++;
                    } else {
                        habit.streak = 1;
                    }
                    habit.lastDone = today;
                    localStorage.setItem('habits', JSON.stringify(this.habits));
                    this.render();
                }
            }

            deleteHabit(id) {
                this.habits = this.habits.filter(h => h.id !== id);
                localStorage.setItem('habits', JSON.stringify(this.habits));
                this.render();
            }

addShoppingItem(name) {
  if (!name.trim()) return;

  const qtyMatch = name.match(/x(\d+)/i);
  const qty = qtyMatch ? Number(qtyMatch[1]) : 1;
  const basePrice = estimatePrice(name);

  const item = {
    id: Date.now(),
    name: name.trim(),
    bought: false,
    price: basePrice * qty,
    quantity: qty,
    category: detectCategory(name)
  };

  this.shopping.push(item);
  localStorage.setItem('shopping', JSON.stringify(this.shopping));
  this.render();
}

addShoppingFromInput() {
  const input = document.getElementById('shoppingInput');
  if (!input) return;

  const value = input.value;
  this.addShoppingItem(value);
  input.value = '';
}

            changeLang(lang) {
                this.lang = lang;
                localStorage.setItem('lang', lang);
                this.render();
            }

            toggleTheme() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', this.theme);
                document.body.classList.toggle('dark-theme');
                this.render();
            }

            showAddTaskModal() {
  document.body.insertAdjacentHTML('beforeend', `
    <div class="modal-backdrop" onclick="this.remove()">
      <div class="modal-content" onclick="event.stopPropagation()">

        <!-- –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="mb-4">
          <h3 class="text-lg font-semibold">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
          <p class="text-sm text-gray-500">–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?</p>
        </div>

        <!-- –ø–æ–ª–µ –≤–≤–æ–¥–∞ -->
        <input
          id="taskText"
          type="text"
          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö—É–ø–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã"
          class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-gray-400 text-base mb-4"
        />

        <!-- –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç -->
        <div class="mb-4">
          <label class="block text-sm text-gray-500 mb-2">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
          <select
            id="taskPriority"
            class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white text-base">
            <option value="low">–ù–∏–∑–∫–∏–π</option>
            <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
            <option value="high">–í—ã—Å–æ–∫–∏–π</option>
          </select>
        </div>

        <!-- –∫–Ω–æ–ø–∫–∏ -->
        <div class="flex gap-3 mt-6">
          <button
            onclick="this.closest('.modal-backdrop').remove()"
            class="flex-1 py-3 rounded-xl border border-gray-200 text-gray-600">
            –û—Ç–º–µ–Ω–∞
          </button>

          <button
            onclick="app.addTaskFromModal()"
            class="flex-1 py-3 rounded-xl bg-gray-900 text-white font-medium">
            –î–æ–±–∞–≤–∏—Ç—å
          </button>
        </div>

      </div>
    </div>
  `);
}
            showAddHabitModal() {
                const modal = document.createElement('div');
                modal.innerHTML = `
                    <div class="modal-backdrop" onclick="app.closeModal()"></div>
                    <div class="modal-content">
                        <h3 class="text-2xl font-bold mb-6 gradient-text">‚ú® ${this.tr('newHabit')}</h3>
                        <input type="text" id="habitInput" placeholder="${this.tr('habitName')}..." 
                            class="w-full p-4 border-2 border-purple-200 rounded-2xl mb-4 text-base focus:outline-none focus:border-purple-500 transition-all">
                        <p class="text-sm font-semibold mb-3 text-gray-700">${this.tr('chooseIcon')}:</p>
                        <div class="grid grid-cols-4 gap-3 mb-6">
                            ${['üí™', 'üìö', 'üèÉ', 'üßò', 'üíß', 'ü•ó', 'üò¥', 'üéØ', 'üö¥', 'üé®', '‚úçÔ∏è', 'üéµ'].map(icon => `
                                <button onclick="app.addHabitFromModal('${icon}')" 
                                    class="py-4 text-3xl bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl active:scale-95 transition-all border-2 border-purple-100">
                                    ${icon}
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="app.closeModal()" 
                            class="w-full py-4 bg-gray-100 text-gray-700 rounded-2xl font-bold active:bg-gray-200 transition-all">
                            ${this.tr('cancel')}
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => document.getElementById('habitInput')?.focus(), 100);
            }

            showShoppingModal() {
                const modal = document.createElement('div');
                modal.innerHTML = `
                    <div class="modal-backdrop" onclick="app.closeModal()"></div>
                    <div class="modal-content">
                        <h3 class="text-2xl font-bold mb-6 gradient-text">üõí ${this.tr('shoppingList')}</h3>
                        <p class="text-sm text-gray-600 mb-3">–í–≤–µ–¥–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</p>
                        <textarea id="shoppingModalInput" placeholder="–•–ª–µ–±\n–ú–æ–ª–æ–∫–æ\n–Ø–π—Ü–∞\n–ú–∞—Å–ª–æ\n..." 
                            class="w-full p-4 border-2 border-purple-200 rounded-2xl mb-4 text-base h-48 focus:outline-none focus:border-purple-500 resize-none transition-all"></textarea>
                        <button onclick="app.estimateShopping()" 
                            class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl font-bold mb-3 shadow-lg active:shadow-md transform active:scale-95 transition-all">
                            üí∞ ${this.tr('estimate')}
                        </button>
                        <button onclick="app.closeModal()" 
                            class="w-full py-4 bg-gray-100 text-gray-700 rounded-2xl font-bold active:bg-gray-200 transition-all">
                            ${this.tr('cancel')}
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => document.getElementById('shoppingModalInput')?.focus(), 100);
            }

            estimateShopping() {
                const input = document.getElementById('shoppingModalInput');
                if (input?.value.trim()) {
                    try {
                        tg.sendData(JSON.stringify({
                            action: 'estimate_shopping',
                            items: input.value.trim()
                        }));
                        this.closeModal();
                    } catch (e) {
                        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                    }
                } else {
                    alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä');
                }
            }


            addHabitFromModal(icon) {
                const input = document.getElementById('habitInput');
                if (input?.value.trim()) {
                    this.addHabit(input.value, icon);
                    this.closeModal();
                }
            }

            closeModal() {
                document.querySelectorAll('.modal-backdrop').forEach(m => m.parentElement?.remove());
            }

            getFiltered() {
                return this.tasks.filter(t => {
                    if (this.view === 'inbox') return t.status === 'inbox' && !t.completed;
                    if (this.view === 'today') return t.status === 'today' && !t.completed;
                    if (this.view === 'focus') return t.status === 'focus' && !t.completed;
                    if (this.view === 'review') return t.completed;
                    return true;
                });
            }

            render() {
                const tasks = this.getFiltered();
                const completed = this.tasks.filter(t => t.completed).length;
                
                document.getElementById('root').innerHTML = `
                    <div class="header bg-white card sticky top-0 z-50">
  <div class="px-4 py-3">
    <div class="flex items-center gap-3">
  <!-- –∞–≤–∞—Ç–∞—Ä -->
  <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-200
            flex items-center justify-center font-semibold text-gray-700">
  ${this.user.photo_url
    ? `<img src="${this.user.photo_url}" class="w-full h-full object-cover" />`
    : this.user.first_name.charAt(0)
  }
</div>

  <!-- –∏–º—è + –¥–∞—Ç–∞ -->
  <div>
    <div class="flex items-center gap-2">
  <h1 class="text-base font-semibold text-gray-900">
    ${this.user.first_name}
  </h1>

  <span class="text-[10px] px-2 py-0.5 rounded-full
    ${this.plan === 'PREMIUM'
      ? 'bg-yellow-100 text-yellow-700'
      : 'bg-gray-100 text-gray-600'}">
    ${this.plan}
  </span>
</div>
    <p class="text-xs text-muted">
      ${new Date().toLocaleDateString('ru-RU', {
        weekday: 'long',
        day: 'numeric',
        month: 'long'
      })}
    </p>
  </div>
</div>

    <div class="tabs flex gap-2 mt-3 overflow-x-auto">
      ${['today','inbox','focus','review','habits','shopping','stats','support','subscription','settings'].map(v => `
        <button
          onclick="app.setView('${v}')"
          class="px-3 py-1.5 text-sm rounded-md transition-all duration-200 ${
            this.view === v
              ? 'bg-gray-900 text-white shadow-sm scale-[1.03]'
              : 'text-gray-600'
          }">
          ${this.tr(v)}
        </button>
      `).join('')}
    </div>
  </div>
</div>

                        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
                        <div class="px-4">
                            ${this.view === 'stats' ? this.renderStats(completed) : 
                              this.view === 'settings' ? this.renderSettings() :
                              this.view === 'subscription' ? this.renderSubscription() :
                              this.view === 'habits' ? `
  <div class="habits-wrap">
    ${this.renderHabits()}
  </div>
` :
                     this.view === 'shopping' ? this.renderShopping() :
                     this.view === 'support' ? this.renderSupport() :
                              this.renderTasks(tasks)}
                        </div>
                    </div>

                    ${['today', 'inbox', 'focus', 'habits'].includes(this.view) ? `
  <button class="fab" onclick="
    ${this.view === 'habits'
      ? 'app.showAddHabitModal()'
      : 'app.showAddTaskModal()'}
  ">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
      <path d="M12 5v14M5 12h14"
        stroke="white"
        stroke-width="2.5"
        stroke-linecap="round"/>
    </svg>
  </button>
` : ''}                `;
            }

            renderTasks(tasks) {
    if (!tasks.length) {
        return `
            <div class="text-center py-20 text-gray-500">
                <p class="text-sm">–ù–µ—Ç –∑–∞–¥–∞—á</p>
                <p class="text-xs mt-2">–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å</p>
            </div>
        `;
    }

    return tasks.map(t => `
        <div class="card px-3 py-3">
            <div class="flex gap-3 items-start">

                <!-- —á–µ–∫–±–æ–∫—Å -->
                <button onclick="app.toggleTask(${t.id})"
  class="w-5 h-5 mt-1 rounded-full border flex items-center justify-center transition cursor-pointer
  ${t.completed ? 'bg-gray-900 border-gray-900 text-white' : 'border-gray-300 hover:border-gray-400'}">
  ${t.completed ? '‚úì' : ''}
</button>

                <!-- —Ç–µ–∫—Å—Ç -->
                <div class="flex-1">
                    <p class="text-[15px] leading-snug font-medium ${
  t.completed ? 'line-through text-gray-400' : 'text-gray-900'
}">
                        ${t.text}
                    </p>

                    <!-- –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç + —Å—Ç–∞—Ç—É—Å -->
                    <div class="flex items-center gap-2 mt-2">
                        <span class="w-2.5 h-2.5 rounded-full ${
  t.priority === 'high'
    ? 'bg-red-500'
    : t.priority === 'medium'
    ? 'bg-amber-400'
    : 'bg-gray-300'
}"></span>

                        <select
                            onchange="app.moveTask(${t.id}, this.value)"
                            class="text-xs text-muted bg-transparent outline-none">
                            <option value="inbox" ${t.status === 'inbox' ? 'selected' : ''}>Inbox</option>
                            <option value="today" ${t.status === 'today' ? 'selected' : ''}>Today</option>
                            <option value="focus" ${t.status === 'focus' ? 'selected' : ''}>Focus</option>
                        </select>
                    </div>
                </div>

                <!-- —É–¥–∞–ª–∏—Ç—å -->
                <button onclick="app.deleteTask(${t.id})"
                    class="text-muted text-lg leading-none">√ó</button>
            </div>
        </div>
    `).join('');
}

            renderHabits() {
  if (!this.habits.length) {
    return `
      <div class="text-center py-20 text-gray-500">
        <p class="text-sm">${this.tr('noHabits')}</p>
        <p class="text-xs mt-2">–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å</p>
      </div>
    `;
  }

  const today = new Date().toISOString().split('T')[0];

  return this.habits.map(h => {
    const isDone = h.lastDone === today;

    return `
      <div class="card">
        <div class="flex items-center gap-4">

          <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl">
            ${h.icon}
          </div>

          <div class="flex-1">
            <p class="font-medium text-gray-900">${h.text}</p>
            <p class="text-sm text-gray-500 mt-1">
              üî• ${this.tr('streak')}: ${h.streak} ${this.tr('days')}
            </p>
          </div>

          <div class="flex gap-2">
            <button
              onclick="app.checkHabit(${h.id})"
              class="w-8 h-8 rounded-full border flex items-center justify-center cursor-pointer
              ${isDone ? 'bg-gray-900 text-white border-gray-900' : 'border-gray-300'}"
              ${isDone ? 'disabled' : ''}>
              ‚úì
            </button>

            <button
              onclick="app.deleteHabit(${h.id})"
              class="text-gray-400 hover:text-red-500 text-xl px-2">
              √ó
            </button>
          </div>

        </div>
      </div>
    `;
  }).join('');
}
            renderStats(completed) {
  const stats = [
    { icon: 'üìã', label: this.tr('total'), value: this.tasks.length },
    { icon: '‚úÖ', label: this.tr('completed'), value: completed },
    { icon: 'üéØ', label: this.tr('habits'), value: this.habits.length },
    { icon: 'üî•', label: 'Streak', value: Math.max(...this.habits.map(h => h.streak), 0) }
  ];

  return `
    <div class="stats-wrap">
      <div class="grid grid-cols-2 gap-3">
        ${stats.map(s => `
          <div class="card flex items-center gap-4">
            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl">
              ${s.icon}
            </div>

            <div>
              <p class="text-xs text-gray-500">${s.label}</p>
              <p class="text-xl font-semibold text-gray-900">${s.value}</p>
            </div>
          </div>
        `).join('')}
      </div>

      <div class="card mt-4">
        <h3 class="text-sm font-medium text-gray-900 mb-2">üìà –ü—Ä–æ–≥—Ä–µ—Å—Å</h3>
        <p class="text-sm text-gray-500 text-center py-8">
          –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        </p>
      </div>
    </div>
  `;
}

            renderSupport() {
  return `
    <div class="support-wrap">

      <div class="card">
        <h3 class="text-sm font-medium text-gray-900 mb-2">
          üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞
        </h3>

        <p class="text-sm text-gray-500 mb-4">
          –ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –∏–¥–µ–∏ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ Telegram.
        </p>

        <a
          href="https://t.me/NextStepSupport"
          target="_blank"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-xl
                 bg-gray-900 text-white text-sm font-medium
                 hover:bg-gray-800 transition">
          <span>–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</span>
        </a>
      </div>

      <div class="card">
        <p class="text-xs text-gray-500">
          –ú—ã —Å—Ç–∞—Ä–∞–µ–º—Å—è –æ—Ç–≤–µ—á–∞—Ç—å –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ.
        </p>
      </div>

    </div>
  `;
}

renderShopping() {
  const total = this.shopping
    .filter(item => !item.bought)
    .reduce((sum, item) => sum + item.price, 0);

  return `
    <div class="card mt-4">
      <h3 class="text-sm font-medium text-gray-900 mb-3">
        üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫
      </h3>

      ${
        this.shopping.length === 0
  ? `
    <div class="py-8 flex flex-col items-center text-center">
      <div class="text-4xl mb-3">üõí</div>
      <p class="text-sm text-gray-700 font-medium">
        –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ø—É—Å—Ç
      </p>
      <p class="text-sm text-gray-400 mt-1">
        –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä –Ω–∏–∂–µ
      </p>
    </div>
  `
  : this.shopping.map(item => `
            <div class="flex items-center gap-3 mb-2">

              <!-- —á–µ–∫–±–æ–∫—Å -->
              <button
                onclick="app.toggleShoppingItem(${item.id})"
                class="w-5 h-5 rounded border flex items-center justify-center transition-all duration-200
${item.bought ? 'bg-gray-900 text-white border-gray-900' : 'border-gray-300'}">
                ${item.bought ? '‚úì' : ''}
              </button>

              <!-- –Ω–∞–∑–≤–∞–Ω–∏–µ -->
              <div class="flex-1">
  <span class="text-sm ${
    item.bought ? 'line-through text-gray-400' : 'text-gray-900'
  }">
    ${item.name}
  </span>

  <div class="text-xs text-gray-400">
    ${item.category === 'products' ? 'ü•¶ –ü—Ä–æ–¥—É–∫—Ç—ã' : 'üßª –ë—ã—Ç'}
  </div>
</div>

              <!-- —Ü–µ–Ω–∞ -->
              <span class="text-sm text-gray-500">
                ${item.price} ‚ÇΩ
              </span>

              <!-- —É–¥–∞–ª–∏—Ç—å -->
              <button
                onclick="app.deleteShoppingItem(${item.id})"
                class="text-gray-400 text-lg leading-none">
                √ó
              </button>

            </div>
          `).join('')
      }
      <div class="border-t mt-4 pt-3 flex justify-between text-sm">
        <span class="text-gray-500">–ò—Ç–æ–≥–æ:</span>
        <span class="font-semibold">${total} ‚ÇΩ</span>
      </div>
      <div class="mt-4 flex gap-2">
  <input
    id="shoppingInput"
    placeholder="–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ö–ª–µ–±)"
    class="flex-1 px-3 py-2 border rounded-lg text-sm"
    onkeydown="if(event.key==='Enter') app.addShoppingFromInput()"
  />

  <button
    onclick="app.addShoppingFromInput()"
    class="px-4 py-2 bg-gray-900 text-white rounded-lg text-sm">
    –î–æ–±–∞–≤–∏—Ç—å
  </button>
</div>
    </div>
  `;
}

toggleShoppingItem(id) {
    const item = this.shopping.find(i => i.id === id);
    if (!item) return;

    item.bought = !item.bought;
    localStorage.setItem('shopping', JSON.stringify(this.shopping));
    this.render();
}

deleteShoppingItem(id) {
    this.shopping = this.shopping.filter(i => i.id !== id);
    localStorage.setItem('shopping', JSON.stringify(this.shopping));
    this.render();
}

renderSettings() {
            return `
                <div class="space-y-4">
                    <div class="glass-card rounded-3xl p-5">
                        <p class="font-bold mb-4 text-gray-900">${this.tr('language')}</p>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="app.changeLang('ru')" 
                                class="py-3 rounded-2xl font-bold transition-all ${this.lang === 'ru' ? 'bg-gradient-to-r from-purple-600 to-purple-700 text-white shadow-lg' : 'bg-gray-100 text-gray-700 active:bg-gray-200'}">
                                üá∑üá∫ –†—É—Å—Å–∫–∏–π
                            </button>
                            <button onclick="app.changeLang('en')" 
                                class="py-3 rounded-2xl font-bold transition-all ${this.lang === 'en' ? 'bg-gradient-to-r from-purple-600 to-purple-700 text-white shadow-lg' : 'bg-gray-100 text-gray-700 active:bg-gray-200'}">
                                üá¨üáß English
                            </button>
                        </div>
                    </div>
                    <div class="glass-card rounded-3xl p-5">
                        <p class="font-bold mb-4 text-gray-900">${this.tr('theme')}</p>
                        <button onclick="app.toggleTheme()" 
                            class="w-full py-3 rounded-2xl font-bold bg-gradient-to-r from-purple-600 to-purple-700 text-white shadow-lg active:shadow-md">
                            ${this.theme === 'light' ? 'üåô ' + this.tr('dark') : '‚òÄÔ∏è ' + this.tr('light')}
                        </button>
                    </div>
                </div>
            `;
        }

        renderSubscription() {
            const plans = [
                {
                    key: 'free',
                    name: 'FREE',
                    icon: 'üÜì',
                    price: '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ',
                    features: ['–î–æ 50 –∑–∞–¥–∞—á', '–ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏', '–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫'],
                    current: this.plan === 'free'
                },
                {
                    key: 'premium',
                    name: 'PREMIUM',
                    icon: '‚≠ê',
                    price: '149‚ÇΩ/–º–µ—Å',
                    features: ['–ë–µ–∑ –ª–∏–º–∏—Ç–æ–≤', '–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', 'AI —Ä–∞—Å—á–µ—Ç –ø–æ–∫—É–ø–æ–∫', '–¢–µ–º–Ω–∞—è —Ç–µ–º–∞'],
                    current: this.plan === 'premium'
                },
                {
                    key: 'pro',
                    name: 'PRO',
                    icon: 'üèÜ',
                    price: '219‚ÇΩ/–º–µ—Å',
                    features: ['–í—Å—ë –∏–∑ Premium', 'AI –ø–æ–º–æ—â–Ω–∏–∫', '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏', '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞'],
                    current: this.plan === 'pro'
                }
            ];
            
            return plans.map(p => `
                <div class="glass-card rounded-3xl p-5 ${p.current ? 'ring-2 ring-white ring-opacity-50 shadow-2xl' : ''} mb-4">
                    ${p.current ? '<div class="inline-block bg-gradient-to-r from-green-500 to-green-600 text-white text-xs font-bold px-4 py-2 rounded-full mb-3 shadow-lg">‚úì –¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ</div>' : ''}
                    <div class="flex items-center gap-4 mb-4">
                        <span class="text-5xl">${p.icon}</span>
                        <div>
                            <h3 class="text-2xl font-bold gradient-text">${p.name}</h3>
                            <p class="text-sm text-gray-600 font-bold">${p.price}</p>
                        </div>
                    </div>
                    <div class="space-y-2 mb-4">
                        ${p.features.map(f => `
                            <div class="flex items-center gap-3 text-sm text-gray-700">
                                <span class="text-green-500 font-bold text-lg">‚úì</span>
                                <span class="font-medium">${f}</span>
                            </div>
                        `).join('')}
                    </div>
                    ${!p.current && p.key !== 'free' ? `
                        <button class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl font-bold shadow-lg active:shadow-md transform active:scale-95 transition-all">
                            ${this.tr('subscribe')}
                        </button>
                    ` : ''}
                </div>
            `).join('') + `<p class="text-xs text-white text-opacity-70 text-center mt-4">üí≥ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Telegram</p>`;
        }
    }

    const app = new App();
    window.app = app;
</script>
</body>
</html>